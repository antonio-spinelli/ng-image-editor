!function(t,e){"use strict";function a(t,e,a,i,r){var n=Math.abs(Math.cos(r)),o=Math.abs(Math.sin(r)),h=t+a/2*Math.cos(r)-i/2*Math.sin(r),c=e+a/2*Math.sin(r)+i/2*Math.cos(r),g=a*n+i*o,d=a*o+i*n;return{cx:h,cy:c,width:g,height:d}}t.module("ngImageEditor.directives",["ngImageEditor.directives.imgDataFromUri","ngImageEditor.directives.imgData","ngImageEditor.directives.imgEditable","ngImageEditor.directives.imgThumb"]),t.module("ngImageEditor",["ngImageEditor.directives"]),t.module("ngImageEditor.directives.imgDataFromUri",[]).directive("imgDataFromUri",[function(){return{restrict:"A",link:function(t,e,i){var r=document.createElement("canvas"),n=r.getContext("2d"),o=new Image;o.onload=function(){var i=r.width=o.width,h=r.height=o.height;n.drawImage(o,0,0);var c=r.toDataURL("image/jpeg",1),g=new Image;if(g.src=c,t.model){var d=t.model.crop(t);if(d&&d.length>0){var s=new Image;s.src=c;var m=d;m.w=m.x2-m.x,m.h=m.y2-m.y,i=r.width,h=r.height;var l=document.createElement("canvas"),u=l.getContext("2d"),w=document.createElement("canvas"),p=w.getContext("2d"),I=a(m.x,m.y,m.w,m.h,0);l.width=w.width=I.width,l.height=w.height=I.height,u.drawImage(s,I.cx-I.width/2,I.cy-I.height/2,I.width,I.height,0,0,I.width,I.height),p.translate(parseInt(l.width/2),parseInt(l.height/2)),p.drawImage(l,parseInt(-l.width/2),parseInt(-l.height/2));var v=I.width/2-m.w/2,f=I.height/2-m.h/2;r.width=m.w,r.height=m.h,i=r.width,h=r.height,n.drawImage(w,-v,-f),s=l=w=u=p=f=v=null,c=r.toDataURL("image/jpeg",1)}if(t.model.rotation(t)){for(var x=t.model.rotation(t);0>x;)x+=360;var y=x/90%4,E=new Image;E.src=c;for(var D=0;y>D;D++)r.width=h,r.height=i,i=r.width,h=r.height,n.save(),n.translate(i,h/i),n.rotate(Math.PI/2),n.drawImage(E,0,0),n.restore(),E.src=r.toDataURL("image/jpeg",1);E=null,c=r.toDataURL("image/jpeg",1)}}t.$broadcast("loadedImg",g,c),e.attr("src",c)},o.crossOrigin="",i.$observe("imgDataFromUri",function(t){o.src=t})}}}]),t.module("ngImageEditor.directives.imgData",[]).directive("imgData",[function(){return{restrict:"A",link:function(t,e,a){var i=t.$eval(a.imgData),r=new FileReader;r.onload=function(){t.$apply(function(){var a=new Image;a.onload=function(){e.attr("src",a.src)},a.src=r.result,t.$broadcast("loadedImg",a,a.src)})},r.readAsDataURL(i)}}}]),t.module("ngImageEditor.directives.imgEditable",[]).directive("imgEditable",["$parse",function(t){return{restrict:"A",link:function(i,r,n){function o(){m=null,r.attr("src",u.src),l.src=u.src}function h(){var t=new Image;t.onload=function(){var e,a,n,o=!1,h=document.createElement("canvas"),c=h.getContext("2d");h.width=t.width,h.height=t.height,a=h.width,n=h.height,c.drawImage(t,0,0,t.width,t.height),o||(o=!0,e=new Image,e.src=h.toDataURL("image/jpeg",1),e.onload=function(){h.width=n,h.height=a,a=h.width,n=h.height,c.save(),c.translate(parseInt(a),parseInt(n/a)),c.rotate(Math.PI/2),c.drawImage(e,0,0),c.restore(),e=null,o=!1,r.attr("src",h.toDataURL("image/jpeg",1)),i.$broadcast("update",h.toDataURL("image/jpeg",1)),h=null})},t.src=r.attr("src"),c()}function c(){var t=new Image;t.onload=function(){var e,a,i,r=!1,n=document.createElement("canvas"),o=n.getContext("2d");n.width=t.width,n.height=t.height,a=n.width,i=n.height,o.drawImage(t,0,0,t.width,t.height),r||(r=!0,e=new Image,e.src=n.toDataURL("image/jpeg",1),e.onload=function(){n.width=i,n.height=a,a=n.width,i=n.height,o.save(),o.translate(parseInt(a),parseInt(i/a)),o.rotate(Math.PI/2),o.drawImage(e,0,0),o.restore(),e=null,r=!1;var t=n.toDataURL("image/jpeg",1);n=null,l.src=t})},t.src=l.src}function g(t){var e=new Image;e.src=r.attr("src");var n=document.createElement("canvas"),o=n.getContext("2d"),h=t,c=n.width,g=n.height,d=document.createElement("canvas"),s=d.getContext("2d"),m=document.createElement("canvas"),l=m.getContext("2d"),u=a(h.x,h.y,h.w,h.h,0);d.width=m.width=u.width,d.height=m.height=u.height,s.drawImage(e,u.cx-u.width/2,u.cy-u.height/2,u.width,u.height,0,0,u.width,u.height),l.translate(parseInt(d.width/2),parseInt(d.height/2)),l.drawImage(d,parseInt(-d.width/2),parseInt(-d.height/2));var w=u.width/2-h.w/2,p=u.height/2-h.h/2;n.width=h.w,n.height=h.h,c=n.width,g=n.height,o.drawImage(m,-w,-p),r.attr("src",n.toDataURL("image/jpeg",1)),i.$broadcast("update",n.toDataURL("image/jpeg",1)),e=n=o=c=g=h=s=l=d=m=u=w=p=null}function d(t,e,a,i,r){if(0===r)return{x:t,y:e};if(180===Math.abs(r))return{x:a-t,y:i-e};var n=r*Math.PI/180,o=t-a/2,h=e-i/2,c=i/2,g=a/2;return{x:parseInt(Math.cos(n)*o-Math.sin(n)*h+c),y:parseInt(Math.sin(n)*o+Math.cos(n)*h+g)}}var s,m,l=new Image,u=new Image;i.model={},i.model.crop=t(n.crop),i.model.rotation=t(n.rotation),i.model.trueSize=t(n.trueSize),i.model.base64=t(n.base64),i.$on("loadedImg",function(t,e,a){i.model.base64.assign(i,a)}),i.$on("update",function(t,e){i.model.base64.assign(i,e)}),i.crop||(i.crop=!1),i.rotation||(i.rotation=0),r.attr("src")&&r.attr("src").length>1&&(l.src=r.attr("src")),i.$on("loadedImg",function(t,e,a){l.src=a,u.src=e.src}),i.$on("crop",function(){if(i.cropping=!0,m=new Image,m.src=r.attr("src"),r.attr("src",l.src),console.log([l.width,l.height]),i.crop){var t=d(i.crop.x,i.crop.y,u.width,u.height,i.rotation),a=d(i.crop.x2,i.crop.y2,u.width,u.height,i.rotation),n=[t.x,t.y,a.x,a.y];e(r).Jcrop({trueSize:[l.width,l.height],setSelect:n},function(){s=this})}else e(r).Jcrop({trueSize:[l.width,l.height]},function(){s=this})}),i.$on("reset",function(){i.crop=!1,i.rotation=0,o(),i.$broadcast("update",u.src)}),i.$on("save",function(){if(i.cropping){m=null,i.cropping=!1;var t=s.tellSelect(),a=d(t.x,t.y,l.width,l.height,-i.rotation),n=d(t.x2,t.y2,l.width,l.height,-i.rotation);i.crop={x:a.x,y:a.y,x2:n.x,y2:n.y},i.model.crop.assign(i,i.crop),e(r).css("width",""),e(r).css("height",""),s.destroy(),g(t)}}),i.$on("cancel",function(){i.cropping&&(i.cropping=!1,r.attr("src",m.src),e(r).css("width",""),e(r).css("height",""),m=null,s.destroy())}),i.$on("rotate",function(){i.rotation=(i.rotation+90)%360,i.model.rotation.assign(i,i.rotation),h()})}}}]),t.module("ngImageEditor.directives.imgThumb",[]).directive("imgThumb",[function(){return{restrict:"A",link:function(t,e,a){t.$on("loadedImg",function(t,a,i){e.attr("src",i)}),t.$on("update",function(t,a){e.attr("src",a)})}}}])}(angular,jQuery);